repos:
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.14.6
    hooks:
      - id: ruff
        args: ["--line-length=120"]

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.18.2
    hooks:
      - id: mypy
        additional_dependencies:
          - types-aiofiles
          - types-requests
          - types-python-dateutil
          - types-bleach
          - types-click
          - types-psutil
          - types-jsonschema
          - types-psycopg2
          - types-python-jose
          - types-networkx
          - jsonschema
          - pydantic-settings>=2.0.0
          - httpx>=0.28.1
          - pytest-asyncio>=1.2.0
          - sqlalchemy[asyncio]>=2.0.0
          - fastapi>=0.119.0
          - starlette>=0.48.0
          - fastapi-users>=14.0.0
          - fastapi-users-db-sqlalchemy>=7.0.0
          - uvicorn>=0.32.1
          - nats-py>=2.9.0
          - structlog>=25.1.0
          - networkx
          - ftfy
          - python-statemachine
          - prometheus-client
          - psutil
          - psycopg2-binary
        args: [--config-file=pyproject.toml, --no-incremental, --show-error-codes, --pretty]
        # Align exclude patterns with pyproject.toml
        # --no-incremental: Disable incremental mode to avoid SQLite cache locking issues in pre-commit hooks
        # Exclude persistence/__init__.py to avoid duplicate module conflict with persistence.py
        # Exclude conftest.py files to avoid duplicate module conflicts (pytest-specific, don't need type checking)
        exclude: ^(data/|client/|scripts/|docs/|tools/|monitoring/|server/alembic/|server/test_who_command_direct\.py|server/tests/|server/tests/scripts/|server/commands/__tests__/|server/persistence/__init__\.py|.*conftest\.py$)

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
        exclude: '\.codacy/'
      - id: trailing-whitespace
        exclude: '\.codacy/'
      - id: check-json
      - id: check-yaml
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: check-executables-have-shebangs
      - id: check-case-conflict
      - id: check-symlinks
      - id: check-ast
      - id: detect-private-key

  - repo: local
    hooks:
      - id: sqlalchemy-async-lint
        name: SQLAlchemy Async Pattern Linter
        entry: python scripts/lint_sqlalchemy_async.py
        language: system
        types: [python]
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
      - id: fstring-logging-lint
        name: F-String Logging Anti-Pattern Detector
        entry: python scripts/check_logging_patterns.py
        language: system
        types: [python]
        pass_filenames: true
        always_run: false
        stages: [pre-commit]
        exclude: ^docs/examples/logging/
      - id: npm-lint
        name: npm lint (client)
        entry: powershell -Command "cd client; npm run lint"
        language: system
        types: [javascript, ts]
        pass_filenames: false
        always_run: true
      - id: npm-format
        name: npm format (client)
        entry: powershell -Command "cd client; npm run format"
        language: system
        types: [javascript, ts, json, markdown]
        pass_filenames: false
        always_run: true
      - id: check-codacy-yaml
        name: Check Codacy YAML Configuration
        entry: python scripts/check_codacy_yaml.py
        language: system
        types: [yaml]
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
      - id: check-coverage-thresholds
        name: Check Coverage Thresholds
        entry: python scripts/check_coverage_thresholds.py
        language: system
        types: [python]
        pass_filenames: false
        always_run: false
        stages: [pre-commit]
        # Only run if coverage.xml exists (after tests have been run)
        # This prevents blocking commits when coverage hasn't been generated
        # Developers should run 'make test-server-coverage' before committing
