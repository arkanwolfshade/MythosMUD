[pytest]
testpaths = server/tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function
# CRITICAL: On Windows, we need to ensure event loops are properly managed for asyncpg
# The default function scope ensures each test gets a fresh event loop
markers =
    e2e: marks tests as end-to-end tests (requires running server and client services)
    slow: marks tests as slow running tests
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    security: marks tests as security tests
    performance: marks tests as performance tests
    regression: marks tests as regression tests
    monitoring: marks tests as monitoring tests
    verification: marks tests as verification tests
    serial: marks tests that must run sequentially (not in parallel) to avoid race conditions
    xdist_group: marks tests to run in the same xdist worker group (use with serial)
addopts =
    --strict-markers
    --strict-config
    -n auto
    --maxfail=1
    --tb=short
    --durations=25
    # Warnings are filtered via filterwarnings below instead of --disable-warnings
    # This allows us to see actual issues while suppressing known harmless warnings
    # Timeout configuration: terminate individual tests after 30s, continue suite
    --timeout=30
    --timeout-method=thread
filterwarnings =
    # Pydantic v2 configuration warnings (from internal implementation)
    ignore::UserWarning:pydantic._internal._config
    ignore:Valid config keys have changed in V2
    # Suppress deprecation warnings from our own code (we know about them and are migrating)
    # These warnings are expected when testing deprecated functions
    ignore::DeprecationWarning:server.utils.room_utils
    ignore:get_local_channel_subject is deprecated:DeprecationWarning
    # Suppress passlib deprecation warnings (we use our own Argon2, but passlib is required for fastapi-users)
    ignore::DeprecationWarning:passlib
    # Suppress harmless event loop closure warnings from TestClient + asyncpg cleanup
    # These occur because TestClient creates its own loop per request on Windows,
    # and asyncpg connections try to clean up after that loop closes
    ignore::RuntimeWarning:.*Event loop is closed.*
    # Suppress RuntimeWarning for unawaited coroutines from AsyncMock
    # These are false positives from unittest.mock's AsyncMock implementation
    # when mocking async functions in tests - the mocks themselves don't need to be awaited
    # The warnings occur during garbage collection when AsyncMock creates internal coroutines
    # that aren't directly awaitable but are detected by Python's GC
    ignore::RuntimeWarning:.*coroutine.*was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'AsyncMockMixin.*was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'countdown_loop' was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'PeriodicOrphanAuditor.*was never awaited.*
    # Suppress RuntimeWarning for HealthMonitor.periodic_health_check_task
    # This occurs when unittest.mock inspects the HealthMonitor class during test discovery
    # The coroutine is only called at runtime, not during test setup, so the warning is benign
    ignore::RuntimeWarning:.*coroutine 'HealthMonitor.periodic_health_check_task' was never awaited.*
    ignore:coroutine 'HealthMonitor.periodic_health_check_task' was never awaited:RuntimeWarning
    # Additional filter for AsyncMock warnings from threading context (pytest-xdist parallel execution)
    ignore:coroutine 'AsyncMockMixin._execute_mock_call' was never awaited:RuntimeWarning
    # Suppress warning for ExplorationService._mark_explored_async coroutine
    # This is expected behavior - the method is fire-and-forget and handles no-loop case gracefully
    # The warning can appear from threading.py during GC, so we need multiple filter formats
    ignore::RuntimeWarning:.*coroutine 'ExplorationService.mark_room_as_explored_sync.*_mark_explored_async' was never awaited.*
    ignore:coroutine 'ExplorationService.mark_room_as_explored_sync.*_mark_explored_async' was never awaited:RuntimeWarning
    # Suppress warning for GameTickService._tick_loop coroutine
    # This occurs during test teardown when GameTickService instances are garbage collected
    # The coroutine is properly managed by the service lifecycle, but GC detects it during cleanup
    ignore::RuntimeWarning:.*coroutine 'GameTickService._tick_loop' was never awaited.*
    ignore:coroutine 'GameTickService._tick_loop' was never awaited:RuntimeWarning
    # Suppress asyncpg Connection._cancel warnings during test teardown
    # These occur when asyncpg connections are garbage collected during test cleanup
    # The connections are properly disposed, but the cleanup coroutines are created
    # after the event loop has closed, causing these harmless warnings
    # Note: These warnings are emitted through pytest's unraisableexception hook,
    # so we need multiple filter formats to catch them all
    ignore:coroutine 'Connection._cancel' was never awaited:RuntimeWarning
    ignore:coroutine.*Connection.*was never awaited:RuntimeWarning
    ignore::RuntimeWarning:.*coroutine 'Connection._cancel' was never awaited.*
    ignore::RuntimeWarning:.*coroutine '.*Connection.*' was never awaited.*
    # Suppress warnings about tracemalloc (used for debugging but not required)
    ignore::RuntimeWarning:Enable tracemalloc.*
    # Note: We do NOT use a broad ignore::RuntimeWarning:.* filter because that would
    # suppress legitimate warnings. The specific filters above should catch known
    # harmless warnings from asyncpg cleanup, AsyncMock, and event loop closures.
    # If new RuntimeWarnings appear, they should be investigated and either fixed
    # or added as specific filters here.
    # Suppress ResourceWarnings (unclosed file handles, event loops, etc.)
    # These are typically from test fixtures and are cleaned up by pytest's teardown
    # Event loop warnings occur on Windows when TestClient creates temporary loops
    ignore::ResourceWarning
    ignore:unclosed event loop:ResourceWarning
    ignore:unclosed.*event loop:ResourceWarning
