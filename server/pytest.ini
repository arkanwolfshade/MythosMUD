[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function
markers =
    e2e: marks tests as end-to-end tests (requires running server and client services)
    slow: marks tests as slow running tests
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    security: marks tests as security tests
    performance: marks tests as performance tests
    regression: marks tests as regression tests
    monitoring: marks tests as monitoring tests
    verification: marks tests as verification tests
    serial: marks tests that must run sequentially (not in parallel) to avoid race conditions
addopts =
    --strict-markers
    --strict-config
    # Warnings are filtered via filterwarnings below instead of --disable-warnings
    # This allows us to see actual issues while suppressing known harmless warnings
    # Timeout configuration: terminate individual tests after 30s, continue suite
    --timeout=30
    --timeout-method=thread
filterwarnings =
    # Pydantic v2 configuration warnings (from internal implementation)
    ignore::UserWarning:pydantic._internal._config
    ignore:Valid config keys have changed in V2
    # Suppress deprecation warnings from our own code (we know about them and are migrating)
    ignore::DeprecationWarning:server.utils.room_utils
    # Suppress passlib deprecation warnings (we use our own Argon2, but passlib is required for fastapi-users)
    ignore::DeprecationWarning:passlib
    # Suppress harmless event loop closure warnings from TestClient + asyncpg cleanup
    # These occur because TestClient creates its own loop per request on Windows,
    # and asyncpg connections try to clean up after that loop closes
    ignore::RuntimeWarning:.*Event loop is closed.*
    # Suppress RuntimeWarning for unawaited coroutines from AsyncMock
    # These are false positives from unittest.mock's AsyncMock implementation
    # when mocking async functions in tests - the mocks themselves don't need to be awaited
    ignore::RuntimeWarning:.*coroutine.*was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'AsyncMockMixin.*was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'countdown_loop' was never awaited.*
    ignore::RuntimeWarning:.*coroutine 'PeriodicOrphanAuditor.*was never awaited.*
    # Suppress asyncpg Connection._cancel warnings during test teardown
    # These occur when asyncpg connections are garbage collected during test cleanup
    # The connections are properly disposed, but the cleanup coroutines are created
    # after the event loop has closed, causing these harmless warnings
    # Note: These warnings are emitted through pytest's unraisableexception hook,
    # so we need multiple filter formats to catch them all
    ignore:coroutine 'Connection._cancel' was never awaited:RuntimeWarning
    ignore:coroutine.*Connection.*was never awaited:RuntimeWarning
    ignore::RuntimeWarning:.*coroutine 'Connection._cancel' was never awaited.*
    ignore::RuntimeWarning:.*coroutine '.*Connection.*' was never awaited.*
    # Suppress warnings about tracemalloc (used for debugging but not required)
    ignore::RuntimeWarning:Enable tracemalloc.*
    # Note: We do NOT use a broad ignore::RuntimeWarning:.* filter because that would
    # suppress legitimate warnings. The specific filters above should catch known
    # harmless warnings from asyncpg cleanup, AsyncMock, and event loop closures.
    # If new RuntimeWarnings appear, they should be investigated and either fixed
    # or added as specific filters here.
    # Suppress ResourceWarnings (unclosed file handles, event loops, etc.)
    # These are typically from test fixtures and are cleaned up by pytest's teardown
    # Event loop warnings occur on Windows when TestClient creates temporary loops
    ignore::ResourceWarning
    ignore:unclosed event loop:ResourceWarning
    ignore:unclosed.*event loop:ResourceWarning
